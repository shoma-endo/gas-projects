# 入稿シート自動作成システム - ワンショットAI抽出版

## 概要

このシステムは、広告媒体の与件情報を1回のOpenAI API呼び出しで全媒体まとめて抽出し、Google Sheetsに自動書き込みを行うGoogle Apps Scriptアプリケーションです。

## 主な特徴

### ✨ ワンショット構造化抽出
- **単一API呼び出し**: 与件全文を1回のリクエストで処理
- **構造化出力**: OpenAIの`response_format`（JSON Schema）により厳密なレスポンス形式を保証
- **マルチ媒体対応**: 複数媒体の情報を同時に抽出・処理

### 🛡️ 堅牢なエラーハンドリング
- 指数バックオフによる自動リトライ（最大3回）
- HTTPステータスコード別のエラー処理（429, 4xx, 5xx）
- スキーマ検証による不正データの検出

### 📊 詳細なロギング
- Submission IDによるリクエスト追跡
- 処理時間・トークン使用量の記録
- 成功/スキップ/エラーの分類集計

## アーキテクチャ

```
┌─────────────────┐
│  Webフォーム     │ (index.html)
└────────┬────────┘
         │ payload
         ▼
┌─────────────────┐
│  receivePlan()  │ コード.js:14
└────────┬────────┘
         │ 1回の呼び出し
         ▼
┌──────────────────────┐
│ analyzeTextAI()      │ 3_AIで情報を解析抽出.js:9
│ - システムプロンプト  │
│ - 構造化スキーマ     │
│ - リトライロジック   │
└────────┬─────────────┘
         │ { medias: [...], unmapped_notes }
         ▼
┌──────────────────────┐
│ processSubmission()  │ コード.js:115
│ - 媒体フィルタリング │
│ - MEDIA_CONFIG突合   │
└────────┬─────────────┘
         │ 各媒体をループ
         ▼
┌──────────────────────────┐
│ insertDataFromStructured() │ 4_テンプレートに書込.js:8
│ - mappingObj参照           │
│ - スプレッドシート書き込み │
└────────────────────────────┘
```

## ファイル構成

| ファイル | 役割 |
|---------|------|
| `コード.js` | メインエントリーポイント（receivePlan, processSubmission） |
| `0_プロンプト.js` | システム/ユーザープロンプト生成 |
| `0_マッピング.js` | 媒体ごとのフィールド→列マッピング定義 |
| `2_テンプレートを判別.js` | MEDIA_CONFIG定義とシート判別ロジック |
| `3_AIで情報を解析抽出.js` | OpenAI API呼び出し・構造化出力処理 |
| `4_テンプレートに書込.js` | スプレッドシートへのデータ書き込み |
| `5_スキーマ定義.js` | JSONスキーマ生成・検証ユーティリティ |

## データフロー

### 1. リクエスト受信（receivePlan）

```javascript
payload = {
  requestText: "与件本文...",
  clientAgency: "代理店名",
  mediaList: ["GDN", "Meta", "LINE"]
}
```

### 2. AI抽出結果（analyzeTextAI）

```json
{
  "medias": [
    {
      "mediaId": "GDN",
      "confidence": 0.95,
      "fields": {
        "予算(グロス)": "1000000",
        "配信開始日": "2025-11-01",
        "配信終了日": "2025-11-30",
        "配信地域": "東京都",
        ...
      }
    },
    {
      "mediaId": "Meta",
      "confidence": 0.88,
      "fields": { ... }
    }
  ],
  "unmapped_notes": "TVCMの情報は含まれていませんでした"
}
```

### 3. 書き込み処理（insertDataFromStructured）

各媒体について:
1. `MEDIA_CONFIG[mediaId]` で `sheet` と `promap` を取得
2. `mappingObj["mapping" + promap]` でフィールド→列マッピングを取得
3. `fields` の各キーを対応する列に書き込み

## 設定

### 必須環境変数

Apps Scriptのプロパティに以下を設定:

```javascript
PropertiesService.getScriptProperties().setProperty(
  "OPENAI_API_KEY",
  "sk-..."
);
```

### 対応媒体（MEDIA_CONFIG）

| mediaId | シート名 | promap |
|---------|---------|--------|
| Googleリスティング | Googleリスティング広告 | 1_1 |
| Yahoo！リスティング | Yahoo!リスティング広告 | 1_2 |
| GDN | GDN広告 | 1_3 |
| YDA | YDA広告 | 1_4 |
| Meta | Meta広告 | 1_5 |
| LINE | LINE広告 | 1_6 |
| X | X広告 | 1_7 |
| TikTok | TikTok広告 | 1_8 |

### スプレッドシートID

`4_テンプレートに書込.js:11` で設定:

```javascript
const spreadsheetId = "1dA8s13XmLDdU0gm4T9HPgJT77Qzcz_T7Wa7on9e6I-s";
```

## ログ

### Submissionsシート

各リクエストの実行履歴を記録:

| 列 | 内容 |
|----|------|
| Timestamp | 実行日時 |
| SubmissionId | リクエストID（YYYYMMDD-HHmmss-SSS形式） |
| RequestText | 与件本文 |
| ClientAgency | クライアント代理店 |
| SelectedMedias | ユーザー選択媒体 |
| ExtractedMedias | AI抽出媒体 |
| Success | 成功件数 |
| Skipped | スキップ件数 |
| Errors | エラー件数 |
| ElapsedMs | 処理時間（ミリ秒） |

### Logger出力

Apps Scriptのログに以下を出力:

```
🚀 processSubmission開始 [20251029-123456-789]
✅ AI抽出完了 [20251029-123456-789] 1234ms | tokens: 567 | medias: 3
  [0] GDN (confidence: 0.95)
  [1] Meta (confidence: 0.88)
  [2] LINE (confidence: 0.92)
📊 抽出された媒体数: 3
  📝 GDN: 25フィールドを行15に書き込み
✅ 成功: GDN → GDN広告
  📝 Meta: 18フィールドを行8に書き込み
✅ 成功: Meta → Meta広告
  📝 LINE: 20フィールドを行12に書き込み
✅ 成功: LINE → LINE広告

📈 処理完了サマリー [20251029-123456-789] 1876ms
  成功: 3件
  スキップ: 0件
  エラー: 0件
```

## エラーハンドリング

### APIエラー

| エラー | 対応 |
|-------|------|
| 429 (Rate Limit) | 指数バックオフで最大3回リトライ（1秒→2秒→4秒） |
| 4xx/5xx | エラーメッセージとレスポンスボディをログ出力 |
| ネットワークエラー | リトライ後にエラー投げ直し |

### スキーマ検証エラー

- `medias`が配列でない
- `mediaId`が未定義
- `fields`がオブジェクトでない
- `mediaId`がMEDIA_CONFIGに存在しない

→ `unmapped_notes`に警告を追記し、処理は継続

### 書き込みエラー

- シートが見つからない
- mappingObjにキーが存在しない

→ 該当媒体をスキップし、`results.errors`に記録

### フロントエンド通知

処理結果に応じて適切なメッセージを表示:

| 状態 | ok | hasPartialErrors | 動作 |
|-----|----|--------------------|------|
| 全成功 | true | false | 「保存完了」メッセージ表示後にダイアログを閉じる |
| 部分成功 | true | true | 「処理完了（一部エラーあり）」+内訳を表示、ダイアログは開いたまま |
| 全失敗/全スキップ | false | - | 「書き込みに成功した媒体がありません」エラーメッセージ、ダイアログは開いたまま |

**判定ロジック**:
- `ok = (successCount > 0)` - 成功が1件でもあればtrue
- `hasPartialErrors = (errorCount > 0 || skippedCount > 0) && successCount > 0` - 成功があるが、エラー/スキップも存在

**全スキップの例**:
```
エラー: 書き込みに成功した媒体がありません（ID: 20251029-123456-789）

⚠️ スキップ: 3件
  ・TikTok (MEDIA_CONFIGに未定義)
  ・Instagram (MEDIA_CONFIGに未定義)
  ・Pinterest (MEDIA_CONFIGに未定義)

詳細はログを確認してください。
```

**部分成功の例**:
```
処理完了（一部エラーあり）（ID: 20251029-123456-789）

✅ 成功: 2件
  ・GDN
  ・Meta

❌ エラー: 1件
  ・LINE: シート「LINE広告」が見つかりません
```

## パフォーマンス

### 旧版との比較

| 項目 | 旧版（媒体×API呼び出し） | 新版（ワンショット） |
|------|------------------------|---------------------|
| API呼び出し回数 | N回（媒体数分） | 1回 |
| レイテンシー | N × レイテンシー + オーバーヘッド | 1 × レイテンシー |
| トークン使用量 | 媒体ごとにプロンプト重複 | プロンプト共有で削減 |
| レート制限リスク | 高（媒体数に比例） | 低 |

### 推奨設定

- `temperature`: 0.1（抽出精度優先）
- `max_tokens`: 4000（複数媒体×多項目に対応）
- `model`: gpt-4o-mini-2024-07-18（構造化出力対応・軽量版）

## トラブルシューティング

### 「AI抽出に失敗しました」

**原因**:
- OpenAI APIキーが未設定/無効
- ネットワークエラー
- レート制限超過

**対処**:
1. スクリプトプロパティの`OPENAI_API_KEY`を確認
2. OpenAIダッシュボードでAPI利用状況を確認
3. ログで詳細エラーメッセージを確認

### 「媒体情報を抽出できませんでした」

**原因**:
- 与件文に媒体名が含まれていない
- プロンプトが不適切

**対処**:
1. 与件文に明確な媒体名を含める（例: "GDN", "Meta", "LINE"）
2. `0_プロンプト.js`のシステムプロンプトを調整

### 「シートが見つかりません」

**原因**:
- MEDIA_CONFIGのsheet名が実際のシート名と不一致
- スプレッドシートIDが間違っている

**対処**:
1. `2_テンプレートを判別.js`のMEDIA_CONFIGを確認
2. スプレッドシートにシートが存在するか確認
3. `4_テンプレートに書込.js:11`のspreadsheetIdを確認

## 今後の拡張

### 検討項目

1. **BigQueryエクスポート**: Submissionsシートをストリーム
2. **Confidenceしきい値**: 低信頼度の媒体を自動レビュー待ち
3. **差分更新**: 既存行の更新サポート
4. **バッチ処理**: 複数リクエストを一括処理
5. **Webhook通知**: Slack/Teams連携

### スキーマ変更時の対応

`mappingObj`に新規フィールドを追加した場合:

1. `0_マッピング.js`の該当`mappingX_Y`配列に`{ key: "新フィールド", col: N }`を追加
2. `5_スキーマ定義.js`の`generateFieldsSchema()`が自動で新フィールドをスキーマに追加
3. プロンプトは自動生成されるため修正不要

## ライセンス

社内利用のため非公開

## 変更履歴

### v2.0.2 (2025-10-29)
- 🐛 **全スキップケースを失敗扱いに修正** (重大)
  - `successCount === 0`の場合は`ok: false`を返す
  - 全スキップ時も「書き込みに成功した媒体がありません」エラー表示
  - ダイアログを開いたままユーザーが内容を確認できる
- ♻️ デフォルトモデルを`gpt-4o-mini-2024-07-18`に切り替え、コスト・レイテンシーを最適化

### v2.0.1 (2025-10-29)
- 🐛 部分的失敗時のユーザー通知を改善
- 🐛 Submission IDをreceivePlan→processSubmissionで一貫して使用
- 🐛 エラー時のmediaListログフォーマット修正
- ✨ フロントエンドで成功/スキップ/エラーの内訳を表示
- ✨ 部分失敗時はダイアログを開いたまま維持

### v2.0.0 (2025-10-29)
- ワンショットAI抽出への完全リファクタリング
- OpenAI構造化出力対応
- リトライロジック実装
- 拡張ロギング機能追加

### v1.0.0 (2025-10-01)
- 初回リリース
- 媒体ごとのAPI呼び出し方式
