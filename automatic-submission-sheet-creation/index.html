<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>å…¥ç¨¿ã‚·ãƒ¼ãƒˆè‡ªå‹•ä½œæˆãƒ•ã‚©ãƒ¼ãƒ </title>
    <style>
      :root {
        --bg:#f7f8fa;
        --card:#fff;
        --ink:#1f2937;
        --muted:#6b7280;
        --pri:#2563eb;
        --red:#dc2626;
        --line:#e5e7eb;
      }
      body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
             color:var(--ink); background:var(--bg); }
      .wrap { max-width:880px; margin:auto; padding:20px; }
      h1 { font-size:22px; margin:0 0 14px; }
      .card { background:var(--card); border:1px solid var(--line); border-radius:12px;
              padding:14px; margin-bottom:14px; }
      .grid { display:grid; gap:10px; }
      .g3   { grid-template-columns:repeat(3, minmax(0, 1fr)); }
      label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
      input[type="number"], input[type="date"], input[type="text"], select {
        width:80%; padding:8px 10px; border:1px solid var(--line);
        border-radius:8px; background:#fff; font-size:14px;
      }
      .radio { display:flex; gap:10px; align-items:center; }
      .radio label { margin:0 6px 0 2px; color:var(--ink); font-size:14px; }
      button { appearance:none; border:1px solid var(--line); background:#fff;
               border-radius:10px; padding:8px 12px; font-size:14px; cursor:pointer; }
      button.primary { background:var(--pri); color:#fff; border-color:var(--pri); }
      button.ghost   { background:transparent; }
      button.red     { background:var(--red); color:#fff; border-color:var(--red); }
      .media-card {
        border:1px dashed var(--line);
        border-radius:10px;
        overflow: hidden;
        margin-bottom: 12px;
      }
      .media-accordion-header {
        background: #f9fafb;
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 14px;
        user-select: none;
        transition: background 0.2s;
      }
      .media-accordion-header:hover {
        background: #f3f4f6;
      }
      .media-accordion-header .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .media-accordion-header .header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .media-accordion-header .icon {
        transition: transform 0.2s;
        font-size: 12px;
      }
      .media-accordion-header.active .icon {
        transform: rotate(180deg);
      }
      .media-accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background: #fff;
      }
      .media-accordion-content.active {
        max-height: 3000px;
        transition: max-height 0.5s ease-in;
      }
      .media-accordion-content-inner {
        padding: 16px;
      }
      .media-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
      .muted { color:var(--muted); }
      .error { color:var(--red); font-size:12px; margin-top:4px; }
      .total { font-weight:600; }
      .footer { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
      .divider { height:1px; background:var(--line); margin:10px 0; }
      @media (max-width:720px) { .g3 { grid-template-columns:1fr; } }
      .req {
        color: var(--red);
        font-weight: bold;
      }
      .loading-indicator {
        color: var(--muted);
      }

      /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
      .accordion {
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
      }
      .accordion-header {
        background: #f9fafb;
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 14px;
        user-select: none;
        transition: background 0.2s;
      }
      .accordion-header:hover {
        background: #f3f4f6;
      }
      .accordion-header .icon {
        transition: transform 0.2s;
      }
      .accordion-header.active .icon {
        transform: rotate(180deg);
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background: #fff;
      }
      .accordion-content.active {
        max-height: 2000px;
        transition: max-height 0.5s ease-in;
      }
      .accordion-content-inner {
        padding: 16px;
      }

      /* 3ã‚«ãƒ©ãƒ ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
      .fields-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px 20px;
      }
      @media (max-width: 1024px) {
        .fields-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 720px) {
        .fields-grid {
          grid-template-columns: 1fr;
        }
      }

      /* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
      .field-item {
        display: grid;
        grid-template-rows: auto 38px;
        align-items: end;
        gap: 6px;
      }
      .field-item label {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
        word-wrap: break-word;
        align-self: start;
      }
      .field-item input,
      .field-item select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--line);
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        height: 38px !important;
        min-height: 38px !important;
        max-height: 38px !important;
        line-height: normal;
        vertical-align: middle;
        /* ã€é‡è¦ã€‘selectã¨inputã®é«˜ã•ã‚’å®Œå…¨ã«çµ±ä¸€ */
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        font-family: inherit;
      }
      .field-item select {
        /* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”¨ã®çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ  */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-color: white;
        padding-right: 30px;
      }
      .dynamic-fields {
        margin-top: 10px;
      }

      /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      }
      .loading-overlay.active {
        display: flex;
      }
      .loading-content {
        background: white;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      .spinner {
        width: 60px;
        height: 60px;
        margin: 0 auto 20px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--pri);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .loading-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--ink);
      }
      .loading-message {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
      }
      .loading-estimate {
        font-size: 12px;
        color: var(--pri);
        margin-top: 12px;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-title">å…¥ç¨¿ã‚·ãƒ¼ãƒˆä½œæˆä¸­...</div>
        <div class="loading-message" id="loadingMessage">AIè§£æã¨æ›¸ãè¾¼ã¿ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™</div>
        <div class="loading-estimate" id="loadingEstimate"></div>
      </div>
    </div>

    <div class="wrap">
      <!-- åŸºæœ¬æƒ…å ± -->
      <div class="card">
        <h2 style="font-size:18px; margin:0 0 12px;">åŸºæœ¬æƒ…å ±</h2>

        <!-- ä¸ä»¶æƒ…å ± -->
        <div style="margin-bottom:12px;">
          <label>ä¸ä»¶æƒ…å ± <span class="req">*</span></label>
          <textarea id="requestText" rows="4" style="width:95%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:14px; font-family:inherit; resize:vertical;" placeholder="ä¸ä»¶æƒ…å ±ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
          <div id="err-requestText" class="error" aria-live="polite"></div>
        </div>

        <!-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»£ç†åº— -->
        <div style="margin-bottom:12px;">
          <label>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»£ç†åº— <span class="req">*</span></label>
          <select id="clientAgency" style="width:30%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:14px;">
            <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
            <!-- ã€è¦‹æœ¬ã€‘ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‹ã‚‰å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
          </select>
          <div id="err-clientAgency" class="error" aria-live="polite"></div>
        </div>

        <!-- ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ é¸æŠ -->
        <div style="margin-bottom:12px;">
          <label>ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä»»æ„ï¼‰</label>
          <div style="display:flex; flex-direction:column; gap:8px; margin-top:6px;">
            <label style="display:flex; align-items:center; font-size:14px; color:var(--ink); cursor:pointer;">
              <input type="checkbox" id="accountRequest" style="width:auto; margin-right:8px;">
              ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé–‹è¨­ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ 
            </label>
            <label style="display:flex; align-items:center; font-size:14px; color:var(--ink); cursor:pointer;">
              <input type="checkbox" id="tagRequest" style="width:auto; margin-right:8px;">
              è¿½åŠ ã‚¿ã‚°ç™ºè¡Œä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ 
            </label>
            <label style="display:flex; align-items:center; font-size:14px; color:var(--ink); cursor:pointer;">
              <input type="checkbox" id="reportRequest" style="width:auto; margin-right:8px;">
              ãƒ¬ãƒãƒ¼ãƒˆä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ 
            </label>
          </div>
        </div>
      </div>

      <!-- åª’ä½“åˆ¥è¨­å®š -->
      <div class="card">
        <div class="media-header">
          <h2 style="font-size:18px; margin:0;">åª’ä½“åˆ¥è¨­å®š</h2>
          <button id="addMediaBtn" class="primary" type="button">ï¼‹ åª’ä½“ã‚’è¿½åŠ </button>
        </div>
        <div id="mediaList" class="grid" style="gap:14px; margin-top:10px;"></div>
        <div id="err-media" class="error" aria-live="polite" style="margin-top:6px;"></div>
      </div>

      <!-- é€ä¿¡ -->
      <div class="card">
        <div class="footer">
          <button id="sendBtn" class="primary" type="button">å…¥ç¨¿ã‚·ãƒ¼ãƒˆä½œæˆ</button>
          <button id="resetBtn" type="button" class="ghost">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>

    <script>
      // ã€ãªãœã€‘åª’ä½“ãƒªã‚¹ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ä¿æŒ
      // â†’ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ä¸€åº¦å–å¾—ã—ãŸåª’ä½“ãƒªã‚¹ãƒˆã‚’ã€è¤‡æ•°ã®åª’ä½“ã‚«ãƒ¼ãƒ‰è¿½åŠ æ™‚ã«å†åˆ©ç”¨ã™ã‚‹ãŸã‚
      // â†’ æ¯å›ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›ã‚‹ã®ã¯éåŠ¹ç‡
      let MEDIA_LIST = [];
      let mediaLoaded = false;

      // ã€ãªãœã€‘ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»£ç†åº—ãƒªã‚¹ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ä¿æŒ
      // â†’ ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã—ãŸãƒªã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦å†åˆ©ç”¨ã™ã‚‹ãŸã‚
      let CLIENT_AGENCY_LIST = [];
      let agencyLoaded = false;

      const mediaListEl = document.getElementById('mediaList');
      const addMediaBtn = document.getElementById('addMediaBtn');
      const sendBtn     = document.getElementById('sendBtn');
      const resetBtn    = document.getElementById('resetBtn');
      const defaultAddMediaLabel = addMediaBtn.textContent;
      addMediaBtn.disabled = true;

      // ã€ãªãœã€‘mediaCardsã§å„ã‚«ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’ç®¡ç†
      // â†’ è¤‡æ•°ã®åª’ä½“ã‚«ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€å„ã‚«ãƒ¼ãƒ‰ã®mediaIdã¨fieldsã‚’å€‹åˆ¥ã«ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
      // â†’ fields: {} ã¯å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’æ ¼ç´ï¼ˆãƒã‚¹ã‚¿ã‹ã‚‰å–å¾—ã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¨å€¤ã®ãƒšã‚¢ï¼‰
      let mediaCards = []; // [{key, mediaId, fields: {...}}]
      let uid = 0;

      function setError(id, msg) {
        const el = document.getElementById(id);
        if (el) el.textContent = msg || "";
      }

      /**
       * åª’ä½“ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
       *
       * ã€ãªãœã“ã®é–¢æ•°ãŒå¿…è¦ã‹ã€‘
       * - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œï¼‹ åª’ä½“ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã«ã€æ–°ã—ã„åª’ä½“ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚
       * - è¤‡æ•°ã®åª’ä½“ã‚’åŒæ™‚ã«å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ï¼ˆä¾‹: Googleã¨Yahooã‚’åŒæ™‚ã«è¨­å®šï¼‰
       *
       * ã€é‡è¦ãªä»•æ§˜å¤‰æ›´ã€‘
       * - å¾“æ¥: å›ºå®šçš„ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆMEDIA_FIELD_DEFSï¼‰ã‚’è¡¨ç¤º
       * - æ–°ä»•æ§˜: åª’ä½“é¸æŠæ™‚ã«ã€ãã®åª’ä½“ã®ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‹ã‚‰å‹•çš„ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—ã—ã¦è¡¨ç¤º
       */
      function addMediaCard(prefill = {}) {
        if (!MEDIA_LIST.length) {
          setError('err-media', 'åª’ä½“ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™');
          return;
        }

        const key  = ++uid;
        const card = document.createElement('div');
        card.className   = 'media-card';
        card.dataset.key = key;

        // ã€ãªãœã€‘ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ§‹é€ ã«å¤‰æ›´
        // â†’ åª’ä½“ã‚«ãƒ¼ãƒ‰ã‚’æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ã«ã—ã¦ã€è¤‡æ•°åª’ä½“é¸æŠæ™‚ã®è¦‹ã‚„ã™ã•ã‚’å‘ä¸Š
        card.innerHTML = `
          <div class="media-accordion-header active" data-accordion-header>
            <div class="header-left">
              <span data-media-label>åª’ä½“ã‚«ãƒ¼ãƒ‰</span>
            </div>
            <div class="header-right">
              <button type="button" class="red" data-act="remove">å‰Šé™¤</button>
              <span class="icon">â–¼</span>
            </div>
          </div>
          <div class="media-accordion-content active" data-accordion-content>
            <div class="media-accordion-content-inner">
              <div>
                <label>åª’ä½“ <span class="req">*</span></label>
                <select data-field="mediaId" style="width:40%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:14px;">
                  <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
                  ${MEDIA_LIST.map(media => `<option value="${media}">${media}</option>`).join('')}
                </select>
                <div class="error" data-err="mediaId"></div>
              </div>
              <div class="loading-indicator" data-loading style="display:none;">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
              <div class="dynamic-fields" data-dynamic-fields></div>
            </div>
          </div>
        `;

        // ã€ãªãœã€‘stateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§çŠ¶æ…‹ã‚’ç®¡ç†
        // â†’ ã‚«ãƒ¼ãƒ‰ã”ã¨ã«mediaIdã¨å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚
        const state = {
          key,
          mediaId: (prefill.mediaId || "").trim(),
          fields: {} // ã€é‡è¦ã€‘å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’æ ¼ç´ï¼ˆä¾‹: {"å…¥æœ­æˆ¦ç•¥": "ç›®æ¨™ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³å˜ä¾¡"}ï¼‰
        };
        mediaCards.push(state);

        const mediaSel = card.querySelector('[data-field="mediaId"]');
        const loadingIndicator = card.querySelector('[data-loading]');
        const dynamicFieldsContainer = card.querySelector('[data-dynamic-fields]');
        const accordionHeader = card.querySelector('[data-accordion-header]');
        const accordionContent = card.querySelector('[data-accordion-content]');
        const mediaLabel = card.querySelector('[data-media-label]');

        // ã€ãªãœã€‘ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰æ©Ÿèƒ½
        // â†’ è¤‡æ•°åª’ä½“é¸æŠæ™‚ã«ã€ä½œæ¥­ä¸­ã§ãªã„åª’ä½“ã‚«ãƒ¼ãƒ‰ã‚’é–‰ã˜ã¦ç”»é¢ã‚’ã™ã£ãã‚Šã•ã›ã‚‹ãŸã‚
        accordionHeader.addEventListener('click', (e) => {
          // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰ã—ãªã„
          if (e.target.matches('[data-act="remove"]')) {
            return;
          }

          accordionHeader.classList.toggle('active');
          accordionContent.classList.toggle('active');
        });

        // ã€ãªãœã€‘åª’ä½“é¸æŠå¤‰æ›´æ™‚ã«loadDynamicFieldsã‚’å‘¼ã³å‡ºã™
        // â†’ é¸æŠã—ãŸåª’ä½“ã«å¿œã˜ã¦ã€ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ã‚’å–å¾—ã™ã‚‹ãŸã‚
        // â†’ åª’ä½“ã”ã¨ã«ç•°ãªã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ§‹æˆã‚’æŒã¤ãŸã‚ã€å‹•çš„ã«å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
        mediaSel.addEventListener('change', () => {
          const selectedMediaId = mediaSel.value;
          state.mediaId = selectedMediaId;
          state.fields = {}; // ã€ãªãœã€‘ãƒªã‚»ãƒƒãƒˆ â†’ åª’ä½“ãŒå¤‰ã‚ã£ãŸã‚‰ä»¥å‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã¯ã‚¯ãƒªã‚¢
          setFieldError(card, 'mediaId', '');

          // ã€ãªãœã€‘ãƒ©ãƒ™ãƒ«æ›´æ–°
          // â†’ åª’ä½“åã‚’ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤ºã—ã¦ã€ã©ã®åª’ä½“ã®ã‚«ãƒ¼ãƒ‰ã‹ã™ãã‚ã‹ã‚‹ã‚ˆã†ã«ã™ã‚‹
          mediaLabel.textContent = `åª’ä½“ã‚«ãƒ¼ãƒ‰ - ${selectedMediaId}`;

          // ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
          loadDynamicFields(selectedMediaId, card, dynamicFieldsContainer, loadingIndicator, state);
        });

        if (state.mediaId && MEDIA_LIST.includes(state.mediaId)) {
          mediaSel.value = state.mediaId;
          mediaLabel.textContent = `åª’ä½“ã‚«ãƒ¼ãƒ‰ - ${state.mediaId}`;
          // åˆæœŸå€¤ãŒã‚ã‚‹å ´åˆã¯å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
          loadDynamicFields(state.mediaId, card, dynamicFieldsContainer, loadingIndicator, state);
        }

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        card.addEventListener('click', (e) => {
          if (e.target.matches('[data-act="remove"]')) {
            e.stopPropagation(); // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰ã‚’é˜²ã
            mediaCards = mediaCards.filter(m => m.key !== key);
            card.remove();
          }
        });

        mediaListEl.appendChild(card);
      }

      /**
       * ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
       *
       * ã€ãªãœã“ã®é–¢æ•°ãŒå¿…è¦ã‹ã€‘
       * - åª’ä½“é¸æŠæ™‚ã«ã€ã‚µãƒ¼ãƒãƒ¼ï¼ˆGASï¼‰ã‹ã‚‰å¯¾å¿œã™ã‚‹ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚
       * - éåŒæœŸå‡¦ç†ï¼ˆgoogle.script.runï¼‰ã‚’é©åˆ‡ã«å‡¦ç†ã—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã†ãŸã‚
       *
       * ã€å‡¦ç†ã®æµã‚Œã€‘
       * 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’é–‹å§‹
       * 2. google.script.run.getMasterSheetData(mediaId)ã‚’å‘¼ã³å‡ºã™
       * 3. æˆåŠŸã—ãŸã‚‰ renderDynamicFields() ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
       * 4. å¤±æ•—ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
       */
      function loadDynamicFields(mediaId, card, container, loadingIndicator, state) {
        if (!mediaId) return;

        // ã€ãªãœã€‘ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        // â†’ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¼ãˆã‚‹ãŸã‚
        // â†’ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã«ã‚ˆã£ã¦ã¯æ•°ç§’ã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
        loadingIndicator.style.display = 'block';
        container.innerHTML = '';

        if (!window.google || !google.script || !google.script.run) {
          loadingIndicator.style.display = 'none';
          container.innerHTML = '<div class="error">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>';
          return;
        }

        // ã€ãªãœã€‘google.script.runã§ã‚µãƒ¼ãƒãƒ¼å´ã®getMasterSheetData()ã‚’å‘¼ã³å‡ºã™
        // â†’ ãƒ–ãƒ©ã‚¦ã‚¶å´ã‹ã‚‰GASã®é–¢æ•°ã‚’éåŒæœŸã§å®Ÿè¡Œã™ã‚‹ãŸã‚
        // â†’ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®èª­ã¿å–ã‚Šã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ã—ã‹è¡Œãˆãªã„
        google.script.run
          .withSuccessHandler((result) => {
            loadingIndicator.style.display = 'none';

            if (!result.success) {
              console.error('âŒ ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', result.error);
              container.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${result.error}</div>`;
              return;
            }

            console.log(`âœ… ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${result.columns.length}å€‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰`);
            // ã€ãªãœã€‘renderDynamicFieldsã‚’å‘¼ã³å‡ºã™
            // â†’ å–å¾—ã—ãŸãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆcolumnsï¼‰ã‚’HTMLã¨ã—ã¦æç”»ã™ã‚‹ãŸã‚
            renderDynamicFields(result.columns, container, state);
          })
          .withFailureHandler((err) => {
            loadingIndicator.style.display = 'none';
            container.innerHTML = `<div class="error">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</div>`;
            console.error('getMasterSheetDataå¤±æ•—:', err);
          })
          .getMasterSheetData(mediaId);
      }

      /**
       * ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã™ã‚‹
       *
       * ã€ãªãœã“ã®é–¢æ•°ãŒå¿…è¦ã‹ã€‘
       * - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è«–ç†çš„ãªã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†ã‘ã‚‹ã“ã¨ã§ã€UIã‚’æ•´ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›®çš„ã®é …ç›®ã‚’è¦‹ã¤ã‘ã‚„ã™ãã™ã‚‹ãŸã‚
       * - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰è‡ªå‹•çš„ã«ã‚«ãƒ†ã‚´ãƒªã‚’åˆ¤å®šã™ã‚‹ãŸã‚
       */
      function categorizeFields(columns) {
        const categories = {
          basic: { label: 'ğŸ“‹ åŸºæœ¬æƒ…å ±', fields: [], order: 1 },
          budget: { label: 'ğŸ’° äºˆç®—è¨­å®š', fields: [], order: 2 },
          schedule: { label: 'ğŸ“… é…ä¿¡æœŸé–“ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', fields: [], order: 3 },
          targeting: { label: 'ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°è¨­å®š', fields: [], order: 4 },
          bidding: { label: 'âš™ï¸ å…¥æœ­ãƒ»æœ€é©åŒ–è¨­å®š', fields: [], order: 5 },
          creative: { label: 'ğŸ¨ ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ»é…ä¿¡é¢', fields: [], order: 6 },
          other: { label: 'ğŸ“Œ ãã®ä»–', fields: [], order: 7 }
        };

        columns.forEach(column => {
          const header = column.header.toLowerCase();

          if (header.includes('äºˆç®—') || header.includes('æ—¥äºˆç®—') || header.includes('kpi')) {
            categories.budget.fields.push(column);
          } else if (header.includes('é–‹å§‹') || header.includes('çµ‚äº†') || header.includes('æ™‚') || header.includes('åˆ†') || header.includes('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«')) {
            categories.schedule.fields.push(column);
          } else if (header.includes('å¹´é½¢') || header.includes('æ€§åˆ¥') || header.includes('åœ°åŸŸ') || header.includes('os') || header.includes('ãƒ‡ãƒã‚¤ã‚¹') || header.includes('ã‚¿ãƒ¼ã‚²') || header.includes('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ') || header.includes('ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹')) {
            categories.targeting.fields.push(column);
          } else if (header.includes('å…¥æœ­') || header.includes('èª²é‡‘') || header.includes('æœ€é©åŒ–') || header.includes('é…ä¿¡æ–¹æ³•')) {
            categories.bidding.fields.push(column);
          } else if (header.includes('é…ä¿¡é¢') || header.includes('ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–') || header.includes('ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ') || header.includes('åºƒå‘Šã‚¿ã‚¤ãƒ—')) {
            categories.creative.fields.push(column);
          } else if (header.includes('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³') || header.includes('åºƒå‘Šã‚»ãƒƒãƒˆ') || header.includes('åºƒå‘Šã‚°ãƒ«ãƒ¼ãƒ—') || header.includes('åºƒå‘Šno') || header.includes('ç›®çš„') || header.includes('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹')) {
            categories.basic.fields.push(column);
          } else {
            categories.other.fields.push(column);
          }
        });

        // ç©ºã®ã‚«ãƒ†ã‚´ãƒªã‚’é™¤å¤–ã—ã¦ã€é †ç•ªé€šã‚Šã«ä¸¦ã¹ã‚‹
        return Object.values(categories)
          .filter(cat => cat.fields.length > 0)
          .sort((a, b) => a.order - b.order);
      }

      /**
       * ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¦ç´ ã‚’ç”Ÿæˆ
       *
       * ã€é‡è¦ãªå¤‰æ›´ã€‘
       * - originalHeader ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’æ›¸ãè¾¼ã¿ç”¨ã®ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
       * - header ã¯è¡¨ç¤ºç”¨ã®åå‰ï¼ˆã€Œ - ã€åŒºåˆ‡ã‚Šï¼‰
       */
      function createFieldElement(column, state) {
        const { header, originalHeader, options, hasOptions } = column;

        // ã€ãªãœã€‘æ›¸ãè¾¼ã¿ç”¨ã®ã‚­ãƒ¼ã‚’æ±ºå®š
        // â†’ originalHeader ãŒã‚ã‚‹å ´åˆï¼ˆãƒšã‚¢ã‚·ãƒ¼ãƒˆç”±æ¥ï¼‰: å…ƒã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åï¼ˆ\nåŒºåˆ‡ã‚Šï¼‰ã‚’ä½¿ç”¨
        // â†’ ãªã„å ´åˆï¼ˆãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆç”±æ¥ï¼‰: header ã‚’ãã®ã¾ã¾ä½¿ç”¨
        const fieldKey = originalHeader || header;

        const fieldItem = document.createElement('div');
        fieldItem.className = 'field-item';

        const label = document.createElement('label');
        label.textContent = header; // è¡¨ç¤ºç”¨ã¯ headerï¼ˆã€Œ - ã€åŒºåˆ‡ã‚Šï¼‰
        fieldItem.appendChild(label);

        let inputElement;

        if (hasOptions && options.length > 0) {
          // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
          inputElement = document.createElement('select');
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = 'é¸æŠã—ã¦ãã ã•ã„';
          emptyOption.disabled = true;
          emptyOption.selected = true;
          inputElement.appendChild(emptyOption);

          options.forEach(optionValue => {
            const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            inputElement.appendChild(option);
          });

          inputElement.addEventListener('change', () => {
            state.fields[fieldKey] = inputElement.value; // fieldKey ã‚’ä½¿ç”¨
          });
        } else {
          // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
          inputElement = document.createElement('input');
          inputElement.type = 'text';
          inputElement.placeholder = 'å…¥åŠ›ã—ã¦ãã ã•ã„';

          inputElement.addEventListener('input', () => {
            state.fields[fieldKey] = inputElement.value; // fieldKey ã‚’ä½¿ç”¨
          });
        }

        inputElement.dataset.fieldHeader = fieldKey; // fieldKey ã‚’ä¿å­˜
        fieldItem.appendChild(inputElement);

        return fieldItem;
      }

      /**
       * ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’ç”Ÿæˆ
       */
      function createAccordion(category, state) {
        const accordion = document.createElement('div');
        accordion.className = 'accordion';

        // ãƒ˜ãƒƒãƒ€ãƒ¼
        const header = document.createElement('div');
        header.className = 'accordion-header';
        header.innerHTML = `
          <span>${category.label} (${category.fields.length}é …ç›®)</span>
          <span class="icon">â–¼</span>
        `;

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        const content = document.createElement('div');
        content.className = 'accordion-content active'; // åˆæœŸçŠ¶æ…‹ã§é–‹ã

        const contentInner = document.createElement('div');
        contentInner.className = 'accordion-content-inner';

        const fieldsGrid = document.createElement('div');
        fieldsGrid.className = 'fields-grid';

        category.fields.forEach(column => {
          const fieldElement = createFieldElement(column, state);
          fieldsGrid.appendChild(fieldElement);
        });

        contentInner.appendChild(fieldsGrid);
        content.appendChild(contentInner);

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
        header.addEventListener('click', () => {
          header.classList.toggle('active');
          content.classList.toggle('active');
        });

        accordion.appendChild(header);
        accordion.appendChild(content);

        return accordion;
      }

      /**
       * å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ»ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
       *
       * ã€æ”¹å–„å†…å®¹ã€‘
       * - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
       * - ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã§æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ã«
       * - å„ã‚«ãƒ†ã‚´ãƒªå†…ã¯2ã‚«ãƒ©ãƒ ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
       */
      function renderDynamicFields(columns, container, state) {
        console.log('ğŸ¨ renderDynamicFields é–‹å§‹:', columns);

        if (!columns || columns.length === 0) {
          container.innerHTML = '<div class="muted" style="font-size:12px; margin-top:8px;">ã“ã®åª’ä½“ã«ã¯ãƒã‚¹ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘
        const categories = categorizeFields(columns);
        console.log('ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘å®Œäº†:', categories);

        // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’ç”Ÿæˆ
        container.innerHTML = ''; // ã‚¯ãƒªã‚¢
        categories.forEach(category => {
          const accordion = createAccordion(category, state);
          container.appendChild(accordion);
        });
      }

      function loadMediaList(force = false) {
        if (!force && mediaLoaded) return;

        addMediaBtn.disabled = true;
        addMediaBtn.textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';

        let didFinish = false;
        let timeoutId = null;
        const finalizeLoading = () => {
          if (didFinish) return;
          didFinish = true;
          if (timeoutId) clearTimeout(timeoutId);
          addMediaBtn.disabled = false;
          addMediaBtn.textContent = defaultAddMediaLabel;
        };

        if (!window.google || !google.script || !google.script.run) {
          setError('err-media', 'åª’ä½“ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰');
          finalizeLoading();
          return;
        }

        timeoutId = setTimeout(() => {
          console.error('åª’ä½“ãƒªã‚¹ãƒˆã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
          setError('err-media', 'åª’ä½“ãƒªã‚¹ãƒˆã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
          finalizeLoading();
        }, 15000);

        google.script.run
          .withSuccessHandler((list) => {
            MEDIA_LIST = Array.isArray(list) ? list : [];
            mediaLoaded = MEDIA_LIST.length > 0;

            if (!mediaLoaded) {
              setError('err-media', 'åª’ä½“ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
              finalizeLoading();
              return;
            }

            setError('err-media', '');
            finalizeLoading();

            if (mediaCards.length === 0) {
              addMediaCard();
            }
          })
          .withFailureHandler((err) => {
            console.error('åª’ä½“ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
            setError('err-media', 'åª’ä½“ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            finalizeLoading();
          })
          .getMediaList();
      }

      function loadClientAgencyList() {
        if (agencyLoaded) return;

        if (!window.google || !google.script || !google.script.run) {
          console.error('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»£ç†åº—ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰');
          return;
        }

        google.script.run
          .withSuccessHandler((list) => {
            CLIENT_AGENCY_LIST = Array.isArray(list) ? list : [];
            agencyLoaded = CLIENT_AGENCY_LIST.length > 0;

            const selectEl = document.getElementById('clientAgency');
            if (!selectEl) return;

            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆã€Œé¸æŠã—ã¦ãã ã•ã„ã€ä»¥å¤–ï¼‰ã‚’å‰Šé™¤
            while (selectEl.options.length > 1) {
              selectEl.remove(1);
            }

            // ã€è¦‹æœ¬ã€‘ãƒã‚¹ã‚¿ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã—ãŸä»£ç†åº—ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
            CLIENT_AGENCY_LIST.forEach(agency => {
              const option = document.createElement('option');
              option.value = agency;
              option.textContent = agency;
              selectEl.appendChild(option);
            });
          })
          .withFailureHandler((err) => {
            console.error('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»£ç†åº—ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã€Œé¸æŠã—ã¦ãã ã•ã„ã€ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹
          })
          .getClientAgencyList();
      }

      function setFieldError(card, field, msg) {
        const el = card.querySelector(`[data-err="${field}"]`);
        if (el) el.textContent = msg || "";
      }

      function validate() {
        let ok = true;
        const requestText = document.getElementById('requestText').value.trim();
        const clientAgency = document.getElementById('clientAgency').value;

        setError('err-requestText', '');
        setError('err-clientAgency', '');
        setError('err-media', '');

        // ä¸ä»¶æƒ…å ±
        if (!requestText) {
          setError('err-requestText', 'ä¸ä»¶æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          ok = false;
        }

        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»£ç†åº—
        if (!clientAgency) {
          setError('err-clientAgency', 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»£ç†åº—ã‚’é¸æŠã—ã¦ãã ã•ã„');
          ok = false;
        }

        // åª’ä½“ã‚«ãƒ¼ãƒ‰ãŒæœ€ä½1ã¤å¿…è¦
        if (mediaCards.length === 0) {
          setError('err-media', 'æœ€ä½1ã¤ã®åª’ä½“ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
          ok = false;
        }

        // ã€ä¿®æ­£ã€‘å„ã‚«ãƒ¼ãƒ‰ã®å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯ - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¿…ãšã‚¯ãƒªã‚¢
        for (const cardEl of mediaListEl.children) {
          const key = Number(cardEl.dataset.key);
          const row = mediaCards.find(m => m.key === key);
          if (!row) continue;

          const mediaValue = (row.mediaId || '').trim();
          if (!mediaValue) {
            setFieldError(cardEl, 'mediaId', 'åª’ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„');
            ok = false;
          } else {
            // ã€é‡è¦ã€‘æ­£ã—ã„å€¤ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            setFieldError(cardEl, 'mediaId', '');
            row.mediaId = mediaValue;
          }
        }

        return ok;
      }


      /**
       * é€ä¿¡ç”¨ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
       *
       * ã€ãªãœã“ã®é–¢æ•°ãŒå¿…è¦ã‹ã€‘
       * - ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã•ã‚ŒãŸå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã€ã‚µãƒ¼ãƒãƒ¼ï¼ˆreceivePlané–¢æ•°ï¼‰ã«é€ä¿¡ã™ã‚‹å½¢å¼ã«æ•´å½¢ã™ã‚‹ãŸã‚
       * - è¤‡æ•°ã®åª’ä½“ã‚«ãƒ¼ãƒ‰ã®æƒ…å ±ã‚’é…åˆ—ã¨ã—ã¦ã¾ã¨ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚
       *
       * ã€é‡è¦ãªä»•æ§˜å¤‰æ›´ã€‘
       * - å¾“æ¥: å›ºå®šçš„ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆdueDate, placementç­‰ï¼‰ã‚’é€ä¿¡
       * - æ–°ä»•æ§˜: å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆstate.fieldsï¼‰ã‚’å±•é–‹ã—ã¦é€ä¿¡
       *   â†’ ä¾‹: { mediaId: "Googleãƒªã‚¹ãƒ†ã‚£ãƒ³ã‚°", "å…¥æœ­æˆ¦ç•¥": "ç›®æ¨™ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³å˜ä¾¡", "ãƒ‡ãƒã‚¤ã‚¹": "PC" }
       *
       * ã€ãªãœ ...rest.fields ã§å±•é–‹ã™ã‚‹ã®ã‹ã€‘
       * - rest.fields ã¯ { "å…¥æœ­æˆ¦ç•¥": "å€¤1", "ãƒ‡ãƒã‚¤ã‚¹": "å€¤2" } ã®ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
       * - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ã§å±•é–‹ã™ã‚‹ã“ã¨ã§ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã«ãªã‚‹
       * - ã“ã‚Œã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒãƒ¼å´ï¼ˆreceivePlanï¼‰ã§ payload.mediaList[0]["å…¥æœ­æˆ¦ç•¥"] ã®ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
       */
      function buildPayload() {
        const requestText = document.getElementById('requestText').value.trim();
        const clientAgency = document.getElementById('clientAgency').value;

        // ã€ãªãœã“ã®ãƒ­ã‚°ãŒå¿…è¦ã‹ã€‘
        // - ãƒ•ã‚©ãƒ¼ãƒ ã§å…¥åŠ›ã•ã‚ŒãŸå‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ãŒæ­£ã—ã state.fields ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚
        // - å•é¡Œ: ã€Œãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼é‹ç”¨è¨˜å…¥ã€åˆ—ã«å€¤ãŒå…¥ã‚‰ãªã„ â†’ ã¾ãšå…¥åŠ›å€¤ãŒstate.fieldsã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        // - ã“ã®ãƒ­ã‚°ã§ mediaCards[].fields ãŒç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ {} ã ã£ãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ã§ã®å€¤ä¿å­˜ãŒå¤±æ•—ã—ã¦ã„ã‚‹
        // - æ­£å¸¸ãªå ´åˆ: fields: { "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç›®æ¨™": "å£²ä¸Š", "å…¥æœ­æˆ¦ç•¥": "ç›®æ¨™ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³å˜ä¾¡" } ã®ã‚ˆã†ãªå½¢
        console.log('ğŸ“¦ mediaCards:', JSON.stringify(mediaCards, null, 2));

        const payload = {
          requestText,
          clientAgency,
          // ã€ãªãœã€‘mediaCardsã‚’mapã§å¤‰æ›
          // â†’ å„ã‚«ãƒ¼ãƒ‰ã®mediaIdã¨fieldsã‚’ã€é€ä¿¡ç”¨ã®å½¢å¼ã«æ•´å½¢ã™ã‚‹ãŸã‚
          mediaList: mediaCards.map(({ key, ...rest }) => {
            // ã€ãªãœã“ã®ãƒ­ã‚°ãŒå¿…è¦ã‹ã€‘
            // - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ ...rest.fields ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚
            // - å•é¡Œ: rest.fields ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ result ã«å±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            // - æ­£å¸¸ãªå ´åˆ: result ã¯ { mediaId: "Googleãƒªã‚¹ãƒ†ã‚£ãƒ³ã‚°", "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç›®æ¨™": "å£²ä¸Š", ... } ã®ã‚ˆã†ãªå½¢
            // - ã‚‚ã— result ã« mediaId ã—ã‹ãªã„å ´åˆã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡ãŒå¤±æ•—ã—ã¦ã„ã‚‹ã‹ã€rest.fields ãŒç©º
            const result = {
              mediaId: rest.mediaId,
              ...rest.fields // ã€é‡è¦ã€‘å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’å±•é–‹ï¼ˆä¾‹: {"å…¥æœ­æˆ¦ç•¥": "å€¤", "ãƒ‡ãƒã‚¤ã‚¹": "å€¤"}ï¼‰
            };
            console.log(`  - ã‚«ãƒ¼ãƒ‰å¤‰æ›: key=${key}, mediaId=${rest.mediaId}, fields=`, rest.fields, 'â†’ result=', result);
            return result;
          })
        };

        // ã€ãªãœã“ã®ãƒ­ã‚°ãŒå¿…è¦ã‹ã€‘
        // - ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹ç›´å‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèªã™ã‚‹ãŸã‚
        // - å•é¡Œ: payload.mediaList[].{ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å} ãŒæ­£ã—ãå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        // - æ­£å¸¸ãªå ´åˆ: payload.mediaList[0] ã¯ { mediaId: "...", "ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç›®æ¨™": "...", ... } ã®ã‚ˆã†ãªå½¢
        // - ã‚‚ã— payload.mediaList[0] ã«å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€ä¸Šè¨˜ã®å¤‰æ›å‡¦ç†ãŒå¤±æ•—ã—ã¦ã„ã‚‹
        // - ã“ã®ãƒ­ã‚°ãŒæ­£å¸¸ã§ã‚‚ã‚µãƒ¼ãƒãƒ¼å´ã§å€¤ãŒå…¥ã‚‰ãªã„å ´åˆã€ã‚µãƒ¼ãƒãƒ¼å´ã®æŠ½å‡ºå‡¦ç†ã«å•é¡ŒãŒã‚ã‚‹
        console.log('ğŸ“¤ é€ä¿¡ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰:', JSON.stringify(payload, null, 2));

        return payload;
      }

      // åˆæœŸåŒ–: åª’ä½“è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã¨åˆæœŸã‚«ãƒ¼ãƒ‰è¿½åŠ 
      addMediaBtn.addEventListener('click', () => {
        if (!MEDIA_LIST.length) {
          loadMediaList(true);
          return;
        }
        addMediaCard();
      });
      loadMediaList();
      loadClientAgencyList();

      sendBtn.addEventListener('click', () => {
        if (!validate()) return;
        const payload = buildPayload();

        // ã€ãªãœã€‘ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        // â†’ å‡¦ç†æ™‚é–“ãŒé•·ã„ï¼ˆè¤‡æ•°åª’ä½“ã§1-3åˆ†ã‹ã‹ã‚‹ï¼‰ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€²æ—ã‚’ç¤ºã™å¿…è¦ãŒã‚ã‚‹
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const loadingEstimate = document.getElementById('loadingEstimate');

        // ã€ãªãœã€‘åª’ä½“æ•°ã‹ã‚‰æ¨å®šæ™‚é–“ã‚’è¨ˆç®—
        // â†’ 1åª’ä½“ã‚ãŸã‚Šç´„10-20ç§’ï¼ˆAIè§£æãŒä¸»ãªæ™‚é–“ï¼‰
        const mediaCount = payload.mediaList ? payload.mediaList.length : 0;
        const estimatedSeconds = mediaCount * 15; // å¹³å‡15ç§’/åª’ä½“
        const estimatedMinutes = Math.ceil(estimatedSeconds / 60);

        loadingMessage.textContent = `${mediaCount}ä»¶ã®åª’ä½“ã‚’å‡¦ç†ä¸­...`;
        loadingEstimate.textContent = `æ¨å®šæ™‚é–“: ç´„${estimatedMinutes}åˆ†`;
        loadingOverlay.classList.add('active');

        sendBtn.disabled = true;
        sendBtn.textContent = 'é€ä¿¡ä¸­â€¦';
        google.script.run
          .withSuccessHandler((res) => {
            // ã€ãªãœã€‘ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
            // â†’ å‡¦ç†å®Œäº†
            loadingOverlay.classList.remove('active');

            sendBtn.disabled = false;
            sendBtn.textContent = 'å…¥ç¨¿ã‚·ãƒ¼ãƒˆä½œæˆ';

            // çµæœã®åˆ†æ
            let message = '';
            const isSuccess = res.ok;

            if (!isSuccess) {
              // æˆåŠŸãŒ1ä»¶ã‚‚ãªã„ï¼ˆå…¨å¤±æ•—ã¾ãŸã¯å…¨ã‚¹ã‚­ãƒƒãƒ—ï¼‰
              message = `ã‚¨ãƒ©ãƒ¼: æ›¸ãè¾¼ã¿ã«æˆåŠŸã—ãŸåª’ä½“ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆID: ${res.id}ï¼‰\n\n`;
            } else if (res.hasPartialErrors) {
              // éƒ¨åˆ†çš„æˆåŠŸ
              message = `å‡¦ç†å®Œäº†ï¼ˆä¸€éƒ¨ã‚¨ãƒ©ãƒ¼ã‚ã‚Šï¼‰ï¼ˆID: ${res.id}ï¼‰\n\n`;
            } else {
              // å…¨æˆåŠŸ
              message = `ä¿å­˜å®Œäº†ï¼ˆID: ${res.id}ï¼‰\n\n`;
            }

            if (res.results) {
              const { success, skipped, errors } = res.results;

              // æˆåŠŸä»¶æ•°
              if (success && success.length > 0) {
                message += `âœ… æˆåŠŸ: ${success.length}ä»¶\n`;
                message += success.map(m => `  ãƒ»${m.mediaId}`).join('\n') + '\n';
              }

              // ã‚¹ã‚­ãƒƒãƒ—ä»¶æ•°
              if (skipped && skipped.length > 0) {
                message += `\nâš ï¸ ã‚¹ã‚­ãƒƒãƒ—: ${skipped.length}ä»¶\n`;
                message += skipped.map(m => `  ãƒ»${m.mediaId} (${m.reason})`).join('\n') + '\n';
              }

              // ã‚¨ãƒ©ãƒ¼ä»¶æ•°
              if (errors && errors.length > 0) {
                message += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${errors.length}ä»¶\n`;
                message += errors.map(m => `  ãƒ»${m.mediaId}: ${m.error}`).join('\n') + '\n';
              }
            }

            // å‚™è€ƒ
            if (res.unmapped_notes) {
              message += `\nğŸ“ å‚™è€ƒ:\n${res.unmapped_notes}`;
            }

            if (!isSuccess) {
              message += `\nè©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            }

            alert(message);

            // æˆåŠŸãŒ1ä»¶ä»¥ä¸Šã‚ã‚Šã€ã‹ã¤éƒ¨åˆ†ã‚¨ãƒ©ãƒ¼ãŒãªã„å ´åˆã®ã¿ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
            if (isSuccess && !res.hasPartialErrors) {
              google.script.host.close();
            }
          })
          .withFailureHandler((err) => {
            // ã€ãªãœã€‘ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
            // â†’ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚
            loadingOverlay.classList.remove('active');

            alert(`é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${err && err.message ? err.message : err}`);
            sendBtn.disabled = false;
            sendBtn.textContent = 'å…¥ç¨¿ã‚·ãƒ¼ãƒˆä½œæˆ';
          })
          .receivePlan(payload);
      });

      // ã€è¿½åŠ ã€‘ä¸ä»¶æƒ…å ±å…¥åŠ›æ™‚ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('requestText').addEventListener('input', () => {
        if (document.getElementById('requestText').value.trim()) {
          setError('err-requestText', '');
        }
      });

      // ã€è¿½åŠ ã€‘ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä»£ç†åº—é¸æŠæ™‚ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('clientAgency').addEventListener('change', () => {
        if (document.getElementById('clientAgency').value) {
          setError('err-clientAgency', '');
        }
      });

      resetBtn.addEventListener('click', () => {
        document.getElementById('requestText').value = '';
        document.getElementById('clientAgency').value = '';
        setError('err-requestText', '');
        setError('err-clientAgency', '');
        setError('err-media', '');
        mediaListEl.innerHTML = '';
        mediaCards = []; uid = 0;
        if (mediaLoaded) {
          addMediaCard();
        } else {
          loadMediaList();
        }
      });
    </script>
  </body>
</html>
